{% extends "base.html" %}
{% block title %}Конструктор опроса{% endblock %}

{% block extra_head %}
<style>
    #questions-container {
        margin: var(--spacing-sm) 0;
    }
    
    #add-question {
        margin-top: var(--spacing-xs);
        margin-bottom: var(--spacing-sm);
        width: 100%;
        padding: var(--spacing-md) var(--spacing-lg);
        font-size: 1rem;
        font-weight: 600;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
    }
    
    #add-question:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    #add-question:active {
        transform: translateY(0);
    }
    
    #survey-form {
        max-width: 900px;
        margin: 0 auto;
        gap: var(--spacing-md) !important;
    }
    
    #survey-form > label {
        margin-bottom: var(--spacing-sm);
    }
    
    #survey-form button[type="submit"] {
        width: 100%;
        margin-top: var(--spacing-sm);
        padding: var(--spacing-md) var(--spacing-lg);
        font-size: 1rem;
    }
    
    .templates-section {
        margin-top: var(--spacing-2xl);
        padding: var(--spacing-xl);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
    }
    
    .templates-section h3 {
        margin-top: 0;
        margin-bottom: var(--spacing-lg);
    }
    
    .templates-section ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .templates-section li {
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
        background: var(--bg);
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid var(--border);
    }
    
    .templates-section li:hover {
        background: var(--primary-light);
        border-color: var(--primary);
        transform: translateX(4px);
    }
    
    .templates-section li:last-child {
        margin-bottom: 0;
    }
    
    /* Стили для блоков вопросов */
    .question-block {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-sm) !important;
    }
    
    .question-block:last-child {
        margin-bottom: 0 !important;
    }
    
    .question-block > label {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        margin-bottom: 0;
    }
    
    /* Чекбокс "Обязательный" */
    .question-block > label:has(input[type="checkbox"]),
    .question-block label:has(.q-required) {
        flex-direction: row;
        align-items: center;
        gap: var(--spacing-sm);
        cursor: pointer;
        font-weight: 500;
        margin-top: var(--spacing-xs);
    }
    
    .question-block input[type="checkbox"],
    .question-block .q-required {
        width: 18px;
        height: 18px;
        margin: 0;
        cursor: pointer;
        accent-color: var(--primary);
        flex-shrink: 0;
        border-radius: 4px;
    }
    
    .question-block input[type="checkbox"]:checked {
        background-color: var(--primary);
    }
    
    /* Кнопки в блоке вопроса */
    .question-block .button {
        margin: 0;
        align-self: flex-start;
        font-family: inherit;
    }
    
    .question-block .add-choice {
        margin-top: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
    }
    
    .question-block .remove-question {
        margin-top: var(--spacing-md);
        align-self: flex-end;
    }
    
    /* Группировка кнопок */
    .question-block .button-group {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
        justify-content: space-between;
        align-items: center;
    }
    
    /* Контейнер для вариантов ответов */
    .question-block .choices {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }
    
    /* Строка варианта ответа */
    .question-block .choice-row {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-xs);
    }
    
    .question-block .choice-row:last-child {
        margin-bottom: 0;
    }
    
    .question-block .choice-row .choice-input {
        flex: 1;
        margin: 0;
        padding: 0.625rem 0.75rem;
        font-size: 0.9375rem;
    }
    
    .question-block .choice-row .remove-choice {
        flex-shrink: 0;
        min-width: 36px;
        width: 36px;
        height: 36px;
        padding: 0;
        font-size: 1.25rem;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<h2>Конструктор опросов</h2>
<p>Добавляйте вопросы, настраивайте типы ответов и публикуйте ссылку.</p>

<div id="builder"></div>

<template id="question-template">
    <div class="question-block">
        <label>Текст вопроса <input type="text" class="q-text" maxlength="500" required></label>
        <label>Тип
            <select class="q-type">
                <option value="single">Один ответ</option>
                <option value="multiple">Несколько ответов</option>
                <option value="text">Текст</option>
                <option value="rating">Рейтинг 1-5</option>
            </select>
        </label>
        <label><input type="checkbox" class="q-required" checked> Обязательный</label>
        <div class="choices"></div>
        <button type="button" class="button small add-choice">Добавить вариант</button>
        <button type="button" class="button danger remove-question">Удалить вопрос</button>
    </div>
</template>

<form id="survey-form" class="card">
    {% csrf_token %}
    <label>Заголовок
        <input type="text" name="title" maxlength="200" required>
    </label>
    <label>Описание
        <textarea name="description" maxlength="1000"></textarea>
    </label>
    <label>Тип опроса
        <select name="survey_type">
            <option value="anonymous">Анонимный</option>
            <option value="public">Публичный</option>
        </select>
    </label>
    <label>Дата окончания
        <input type="datetime-local" name="ends_at">
    </label>
    <label>Приветственное сообщение
        <input type="text" name="welcome_message" maxlength="255">
    </label>
    <label>Финальное сообщение
        <input type="text" name="thank_you_message" maxlength="255">
    </label>
    <div id="questions-container"></div>
    <button type="button" id="add-question">Добавить вопрос</button>
    <button type="submit" class="button primary">Сохранить опрос</button>
</form>

<section class="templates-section">
    <h3>Шаблоны</h3>
    <ul>
        {% for tpl in templates %}
            <li data-template="{{ tpl.id }}">{{ tpl.title }} — {{ tpl.get_category_display }}</li>
        {% endfor %}
    </ul>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('questions-container');
    const addBtn = document.getElementById('add-question');
    const tmpl = document.getElementById('question-template');

    function addQuestion(data = null) {
        const clone = tmpl.content.cloneNode(true);
        const block = clone.querySelector('.question-block');
        const text = block.querySelector('.q-text');
        const type = block.querySelector('.q-type');
        const required = block.querySelector('.q-required');
        const choicesWrap = block.querySelector('.choices');
        const addChoiceBtn = block.querySelector('.add-choice');
        const removeBtn = block.querySelector('.remove-question');

        function addChoice(value = '') {
            const div = document.createElement('div');
            div.className = 'choice-row';
            div.innerHTML = `<input type="text" class="choice-input" maxlength="200" value="${value}" required>
                             <button type="button" class="button danger small remove-choice">×</button>`;
            div.querySelector('.remove-choice').onclick = () => div.remove();
            choicesWrap.appendChild(div);
        }

        addChoiceBtn.onclick = () => addChoice();
        removeBtn.onclick = () => block.remove();
        type.onchange = () => {
            choicesWrap.style.display = type.value === 'text' || type.value === 'rating' ? 'none' : 'block';
            addChoiceBtn.style.display = choicesWrap.style.display;
        };

        if (data) {
            text.value = data.text;
            type.value = data.question_type;
            required.checked = data.is_required;
            // Добавляем варианты только для типов, которые их поддерживают
            if (data.choices && data.question_type !== 'text' && data.question_type !== 'rating') {
                data.choices.forEach(choice => addChoice(choice.label));
            }
        } else {
            addChoice('Вариант 1');
            addChoice('Вариант 2');
        }

        type.dispatchEvent(new Event('change'));
        container.appendChild(block);
    }

    addBtn.onclick = () => addQuestion();
    addQuestion();

    document.querySelectorAll('[data-template]').forEach(node => {
        node.addEventListener('click', async () => {
            const id = node.getAttribute('data-template');
            
            // Показываем индикатор загрузки
            const originalText = node.textContent;
            node.textContent = 'Загрузка...';
            node.style.opacity = '0.6';
            
            try {
                const resp = await fetch(`/api/templates/${id}/`);
                if (resp.ok) {
                    const template = await resp.json();
                    const payload = template.payload;
                    
                    // Заполняем основную форму
                    const form = document.getElementById('survey-form');
                    form.title.value = payload.title || template.title;
                    form.description.value = payload.description || template.description;
                    form.survey_type.value = payload.survey_type || 'anonymous';
                    
                    if (payload.ends_at) {
                        const date = new Date(payload.ends_at);
                        const localDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
                        form.ends_at.value = localDate.toISOString().slice(0, 16);
                    } else {
                        form.ends_at.value = '';
                    }
                    
                    form.welcome_message.value = payload.welcome_message || '';
                    form.thank_you_message.value = payload.thank_you_message || '';
                    
                    // Очищаем существующие вопросы
                    container.innerHTML = '';
                    
                    // Добавляем вопросы из шаблона
                    if (payload.questions && payload.questions.length > 0) {
                        payload.questions.forEach((qData, index) => {
                            const questionData = {
                                text: qData.text || '',
                                question_type: qData.question_type || 'single',
                                is_required: qData.is_required !== undefined ? qData.is_required : true,
                                choices: qData.choices || []
                            };
                            addQuestion(questionData);
                        });
                    } else {
                        // Если вопросов нет, добавляем один пустой
                        addQuestion();
                    }
                    
                    // Восстанавливаем текст шаблона
                    node.textContent = originalText;
                    node.style.opacity = '1';
                    
                    // Прокручиваем к началу формы
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    node.textContent = originalText;
                    node.style.opacity = '1';
                    alert('Не удалось загрузить шаблон');
                }
            } catch (error) {
                console.error('Ошибка при загрузке шаблона:', error);
                node.textContent = originalText;
                node.style.opacity = '1';
                alert('Не удалось применить шаблон');
            }
        });
    });

    document.getElementById('survey-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
            title: event.target.title.value,
            description: event.target.description.value,
            survey_type: event.target.survey_type.value,
            ends_at: event.target.ends_at.value ? new Date(event.target.ends_at.value).toISOString() : null,
            welcome_message: event.target.welcome_message.value,
            thank_you_message: event.target.thank_you_message.value,
            questions: [...container.querySelectorAll('.question-block')].map((block, index) => {
                const type = block.querySelector('.q-type').value;
                const choices = (type === 'single' || type === 'multiple')
                    ? [...block.querySelectorAll('.choice-input')].map((input, pos) => ({
                        label: input.value,
                        order: pos
                    }))
                    : [];
                return {
                    text: block.querySelector('.q-text').value,
                    question_type: type,
                    is_required: block.querySelector('.q-required').checked,
                    order: index,
                    choices
                };
            })
        };

        const csrftoken = document.querySelector('#survey-form [name=csrfmiddlewaretoken]').value;
        const response = await fetch('/api/surveys/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(payload)
        });
        if (response.ok) {
            const data = await response.json();
            window.location.href = `/surveys/${data.slug}/`;
        } else {
            const err = await response.json();
            alert('Ошибка: ' + JSON.stringify(err));
        }
    });
});
</script>
{% endblock %}

